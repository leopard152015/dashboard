---
title: "Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    theme: spacelab
---

```{r setup, include=FALSE}
#lanSad
library(flexdashboard)
library(plotly)
library(dygraphs)
library(DBI)
library(mcga)
library(plyr)
library(pracma)
source("SqlSelection.R")
source("Plotter.R")
source("MathMod.R")

#define global variables
sizeDb <- 0
frequency <- 0
startTime <- 0
stopTime <- 0
deltaT <- 0

data <- data.frame()


# Define the list of available databases
lookupDb <- structure(c("databases/dbWalkMB61Hz.db", "databases/db50SquatsMPh16Hz.db","databases/dbEating.db", "databases/db50SquatsMB(61Hz).db","databases/dbEatingFatherMB(61Hz).db",
                        "databases/dbWalkMB-MPh.db"), .Names = c("Walk-MB(61Hz)", "Squats50-MPh(16Hz)", "Eat-Mb(61Hz)", "Squats50-MB(61Hz)", "Eat-Father-Mb(61Hz)","WalkMB-MPh(GPS)"))
nameDb <- reactive( as.character(input$database))

dbCurrent <- 0

namePf <- reactive( as.character(input$platforme_type))

nameDs <- reactive( as.character(input$datasource))

nameAxis <- reactive(as.character(input$axis))

```

Sidebar {.sidebar}
======================================================================


```{r}

# Define input database
selectInput('database', label = h4('Select a database'), choices = lookupDb, selected = "dbEating.db")

# Define input platforme type
selectInput('platforme_type', label = h4('Select a platforme type'), choices = lookupPf, selected = "")

# Define input database
selectInput('datasource', label = h4('Select a signal type'), choices = lookupDs, selected = "Accelerometer")

# Define input cut off
selectInput('axis', label = 'Select a axis', choices = lookupAxis, selected = "X")

connection <- reactive(openDatabase(nameDb()))

data <- reactive(selectData(connection(), nameDs(), namePf()))

sizeDb <- reactive(nrow(data()))

textInput('limitmin', label="min sample", value = 1)
textInput('limitmax', label="max sample", value = 100)

sliderInput('span', label = 'Low Cutoff Fragment', min = 0.1, max = 0.9, value = 0.3, step = 0.1)
#sliderInput('spanHigh', label = 'High Cutoff Fragment', min = 1, max = #10000, value = sizeDb(), step = 1)



```

Found records = `r reactive(sizeDb())`

Frequency = `r reactive(frequency())`

Start time of recording = `r reactive(as.character(startTime()))`

Stop time of recording = `r reactive(as.character(stopTime()))`

Signal
======================================================================


Row
-----------------------------------------------------------------------

### Calories
```{r}

#calories <- computeCalories()
dtCalory <- reactive(selectHealthData(connection(), "'CALORY_BURN'" ,"'MICROSOFT_BAND'" ))

  minCl <- reactive(min(dtCalory()$x))
  maxCl <- reactive(max(dtCalory()$x))
  calories <- reactive(maxCl()-minCl())

renderValueBox({
        valueBox(
          value = tags$p(style = "font-size: 30px;",calories()),
           "Calories", icon = "fa-fire"
        )
      })

```


### Heart Rate
```{r}
dtHr <- reactive(selectHealthData(connection(), "'HEART_RATE'" ,"'MICROSOFT_BAND'" ))

 hr <- reactive(mean(dtHr()$x))

renderValueBox({
        valueBox(
          value = tags$p(style = "font-size: 30px;",(formatC(hr(),digits=3))),
           "Heart rate", icon = "fa-heartbeat"
     #   color = ifelse(hr > 170, "warning", "primary")
        )
      })
    
```

### Steps
```{r}
dtSteps <- reactive(selectHealthData(connection(), "'STEP_COUNT'" ,"'MICROSOFT_BAND'" ))

  minSt <- reactive(min(dtSteps()$x))
  maxSt <- reactive(max(dtSteps()$x))
  steps <- reactive(maxSt()-minSt())

renderValueBox({
        valueBox(
          value = tags$p(style = "font-size: 30px;",steps()),
           "Steps"
        )
      })
```


### Temperature
```{r}
dtTemp <- reactive(selectHealthData(connection(), "'SKIN_TEMPERATURE'" ,"'MICROSOFT_BAND'" ))

  temp <- reactive(mean(dtTemp()$x))

renderValueBox({
        valueBox(
          value = tags$p(style = "font-size: 30px;",(formatC(temp(),digits=3))),
          "Temperature"
        )
      })

#hr<- 5#computeHR()
#valueBox(hr, 
#         icon = "fa-heartbeat",
#         color = ifelse(hr > 170, "warning", "primary"))
```

### Speed
```{r}
dtSpeed <- reactive(selectHealthData(connection(), "'SPEED'" ,"'MICROSOFT_BAND'" ))

  speed <- reactive(mean(dtSpeed()$x))

renderValueBox({
        valueBox(
          value = tags$p(style = "font-size: 30px;",(formatC(speed(),digits=3))),
          "Speed"
        )
      })

```

### Activity
```{r}
dtMotion <- reactive(selectHealthData(connection(), "'MOTION_TYPE'" ,"'MICROSOFT_BAND'" ))

motion <- reactive(dtMotion()$x)

renderValueBox({
        valueBox(
          value = tags$p(style = "font-size: 30px;", motion()),
          "Motion"
        )
      })

```



### Drink
```{r}
v <- 5#computeHR()
valueBox(
         value = tags$p(style = "font-size: 30px;",v),
         icon = "fa-coffee",
         color = ifelse(v > 170, "warning", "primary"))
```

### Food
```{r}
v <- 5#computeHR()
valueBox( 
         value = tags$p(style = "font-size: 30px;",v),
         icon = "fa-cutlery",
         color = ifelse(v > 170, "warning", "primary"))
```


Row {.tabset }
------------------------------------------------------------------------

### Signal  


```{r }
selectData <- function(con, ds, pf){

  switch(ds,
         "'ACCELEROMETER'" = selectMovementData(con, ds, pf),
         "'GYROSCOPE'" = selectMovementData(con, ds, pf),
         "'HEART_RATE'" = selectHealthData(con, ds, pf),
         "'SKIN_TEMPERATURE'" = selectHealthData(con, ds, pf),
         "'GALVANIC_SKIN_RESPONSE'" = selectHealthData(con, ds, pf),
         "'SPEED'" = selectHealthData(con, ds, pf),
         "'STEP_COUNT'" = selectHealthData(con, ds, pf),
         "'CALORY_BURN'" = selectHealthData(con, ds, pf),
         "'DISTANCE'" = selectHealthData(con, ds, pf),
         "'PACE'" = selectHealthData(con, ds, pf),         
         "'MOTION_TYPE'" = selectHealthData(con, ds, pf), 
         "'RR_INTERVAL'" = selectHealthData(con, ds, pf))
} 
plotData <- function(ds, data){

  switch(ds,
        "'ACCELEROMETER'" = plotMovementData(data, "Accelerometer"),
         "'GYROSCOPE'" = plotMovementData(data, "Gyroscope"),
         "'HEART_RATE'" = plotHealthData(data, "Heart rate"),
         "'SKIN_TEMPERATURE'" = plotHealthData(data, "Skin Temperature"),
         "'GALVANIC_SKIN_RESPONSE'" = plotHealthData(data, "Galvanic skin temperature"),
         "'SPEED'" = plotHealthData(data, "Speed"),
         "'STEP_COUNT'" = plotHealthData(data, "Step count"),
         "'CALORY_BURN'" = plotHealthData(data, "Calory burn"),
         "'DISTANCE'" = plotHealthData(data, "Distance"),
         "'PACE'" = plotHealthData(data, "Pace"),         
         "'MOTION_TYPE'" = plotHealthData(data, ""),
         "'RR_INTERVAL'" = plotHealthData(data, "RR interval")) 
}
comuteSizeDb <- function(data){
    return(length(data))
}  
## data-width=650

# data <- reactive(selectData(connection(), nameDs(), namePf()))

output$scatter <- renderDygraph({ plotData(nameDs(), data())}) #renderPlotly({ plotData(nameDs(), data())}) 
dygraphOutput('scatter', width = "80%")
# plotlyOutput('scatter', width = "80%")

#sizeDb <- reactive(nrow(data()))
minTime <-reactive(data()[1,]$dt)
maxTime <- reactive(data()[sizeDb(),]$dt)

startTime <- reactive(minTime())
stopTime <- reactive(maxTime())

deltaT <- reactive((as.numeric(maxTime()) - as.numeric(minTime()))/sizeDb())



frequency <- reactive(1/deltaT())
 # reactive({ switch(namePf(), )
#  data <- reactive(selectMovementData(connection(), nameDs(), namePf()))

#    output$scatter <- renderPlotly({ plotMovementData(data())})  
#    plotlyOutput('scatter', width = "80%")
  
#  data <- reactive(selectHealthData(connection(), nameDs(), namePf()))

 #   output$scatter <- renderPlotly({ plotHealthData(data())})  
#    plotlyOutput('scatter', width = "80%")
    
```

### Table
```{r}
#library(DT)
# renderDataTable({ 
#  DT::datatable(data()) %>% formatStyle(
 #   'x',
#    backgroundColor = styleInterval(3.4, c('gray', 'yellow'))
#  )
#})


renderPrint({
    summary(data())
  })


```


Column {data-width=350}
-----------------------------------------------------------------------

### Integral

```{r}
selectFragment <- function(sig, axis, a, b, const){

  len = nrow(sig)
  med = 0


switch(axis,
         "X" = {subset <- sig$x[c(a:b)]; allowSigCentred <- T } ,
         "Y" = {subset <- sig$y[c(a:b)]; allowSigCentred <- F} ,
         "Z" = {subset <- sig$z[c(a:b)]; allowSigCentred <- F} )
#  subset_x <- sig$x[c(a:b)]
 

  
  if (const == TRUE){
    med<-mean(subset)
    main_axis <- subset - med

  }else
  {
    main_axis <- subset
  }

   switch(axis,
         "X" = {x <- main_axis; y <- sig$y[c(a:b)]; z <- sig$z[c(a:b)]; allowSigCentred <- T; allowFirstCentred <- T;  },
         "Y" = {y <- main_axis; x <- sig$x[c(a:b)]; z <- sig$z[c(a:b)]; allowSigCentred <- F; allowFirstCentred <- F; },
         "Z" = {z <- main_axis; x <- sig$x[c(a:b)]; y <- sig$y[c(a:b)];allowSigCentred <- F; allowFirstCentred <- T;  } )
 # y <- sig$y[c(a:b)]
#  z <- sig$z[c(a:b)]
  counter <- c(a:b)
  fragment <- data.frame(counter, x, y , z)
  
  return( fragment)
}  
allowSigCentred <- T
allowFirstCentred <- T
a <- reactive(input$limitmin)#335
b <- reactive(input$limitmax)#5000

data <- reactive(selectData(connection(), nameDs(), namePf()))
data_correct <- reactive(deleteBias_1(data()))
frgmnt <- reactive(selectFragment(data_correct(), nameAxis(), a(), b(), 
allowSigCentred ))


intgrl <- reactive(integral(frgmnt()$x, 0, length(frgmnt()$x), deltaT(), T) )


#library(signal)
#reactive({
#cutoffHz <- 1.28
#sampleHz <- reactive(frequency())
#nyqHz = sampleHz()/2
#f <- butter(9, cutoffHz/nyqHz, type="low" )
#ts[,c('ly2') := lapply(.(y2), function(x)(filtfilt(f,intgrl())))]
#intgrl()$y2 <-ts$y2 - ts$ly2
#})


#intgrl()$y2 <- b})

output$integral <- renderDygraph({ plotIntegral(intgrl(),input$spanLow)})
dygraphOutput('integral', width = "40%", height = "30%")
#output$integral <- renderPlotly({ plotIntegral(intgrl(),input$spanLow)}) 
#plotlyOutput('integral', width = "40%")


# Drag event for the scatterplot; will grab tractids of selected points
#sub <- reactive({

#    eventdata <- event_data('plotly_selected', source = 'source')
    
#    if (is.null(eventdata)) {
      
#      return(NULL) # do nothing
      
#    } else {
      
 #     tracts <- eventdata[['key']]
      
  #    if (length(tracts) == 0) {
        
   #     tracts <- 'abcdefg' # a hack but it's working - set to something #that can't be selected
        
 #     }


  #      return(sub)
        
    
   # }

 # })


```

### Density

```{r}
data <- reactive(selectData(connection(), nameDs(), namePf()))
#output$density <- renderPlotly({ plotDensity(data(), nameAxis())}) 
#plotlyOutput('density', width = "40%")
output$density <- renderDygraph({ plotDensity(data(), nameAxis())})
dygraphOutput('Density', width = "40%", height = "30%")


```

Results
======================================================================

Row
-----------------------------------------------------------------------

